[toc]

## 前言

为什么有这一篇文档呢？我们之前用 mindie 镜像开发的常规步骤是使用 vscode ssh 连接到宿主机，然后再使用 vscode 的插件进入进行中的容器。但是这个方式在最近的 **75 服务器上失灵了**，它现在可以 ssh 连进去，但是却不能够再**通过插件**进到容器里了！目前我们并不清楚是什么原因导致了这个问题，但是开发工作要继续。在连续使用几天终端操作容器，vscode 连接宿主机开发的糟糕体验之后，实在忍不了了，决定必须找一个**解决方法**。至于为什么这样开发很难受，当你体验了每写一个文件就要 chmod、chown、chgrp 三连，以及完全无法使用 python debugger 进行调试之后，你会和我感同身受的。

与其等待服务器那边修复，不如我们发挥一点主观能动性，想想办法搞个自己的解决方案！加班研究了一下终于是弄出来了，下面给大家分享一下我的成果，我觉得会有帮助的。

⚠️⚠️⚠️本教程会使用自定义端口，有端口冲突的风险，还请慎重选择端口，避免冲突。⚠️⚠️⚠️

## 操作步骤

首先，我当然是默认你已经熟悉之前的 vscode 连接宿主机再进容易这样一套开发动作了。

### 1 使用终端进入容器

前言已经交代了，当前遇到的情况是 vscode 可以通过 ssh 连接到主机，但是不能使用插件连接到容器。但是我们可以使用终端的 `docker exec -itxxxxx` 来进入。这样我们就可以在容器中进行一些操作。

### 2 在容器中安装 ssh service

mindie 镜像默认是没有包含 ssh 的，所以我们要自己装：

1. `apt-get update`
2. `apt-get install openssh-server`

### 3 配置容器用户名密码

我们既然想要通过 ssh 进入容器，那么显然是需要用户名和密码的，docker 容器默认是 root 用户但是无密码，因此我们需要手动配置。这里说明一下，docker 里的密码不会影响宿主机密码，所以可以放心：`passwd` 设置密码，然后再输入一遍确认密码，即可。

### 4 容器中配置 sshd_config

目标路径：`/etc/ssh/sshd_config`

按理说我们需要设置一些参数，但是我们的宿主机肯定是已经配置好了 ssh 嘛，我们直接拿来用就行，省去不少功夫。

1. 前往**宿主机**，`cat /etc/ssh/sshd_config`
2. 将输出内容全部复制到剪贴板
3. 前往**容器**，`vim /etc/ssh/config`
4. 使用 `:%d` 清空所有内容，然后 `i` 进入编辑模式，将宿主机的 config 内容复制进去
5. 修改 `Port 22` 为 `Port XXXX`，其中 `XXXX` 为一个你自定义的端口。
6. 重启容器的 ssh 服务：`service ssh restart`

**说明**：我们的容器实例化的时候就使用了 `--net=host` 参数，也即共享网络栈，因此我们只需要配置容器中的 ssh 进程使用的端口，就可以连接到容器的 ssh 服务。（实例化参数见 `start-docker.sh`，在我的一篇文档“从 0 开始的量化之路”里有更详细的说明）

⚠️⚠️⚠️ 请注意，这里的操作可能导致端口冲突，请确保自定义的端口不会被其他任何进程占用。如果本方法推广开来，则建议服务器管理员给用户分配端口。⚠️⚠️⚠️

### 5 使用 vscode 的 ssh 方式直连容器内部

1. 点击左下角，之后点击 `Connect to Host...`
2. 点击 `Add New SSH Host`
3. 输入命令：`ssh root@10.175.119.75 -A -p {自定义端口}`
4. 后续使用步骤 3 中的密码登录即可。

## 简略版

不想看那么多说明文字？直接开干：

### 配置方式

```sh
# 终端连接容器
apt-get update
apt-get install openssh-server
# 配置容器 root 密码
passwd
# 将宿主机 /etc/ssh/sshd_config 内容复制
# 粘贴到容器 /etc/ssh/sshd_config 中
# 修改 Port {自定义端口}
service ssh restart
```

### 连接方式

```sh
ssh root@10.175.119.75 -A -p {自定义端口}
# 密码使用容器 root 的密码
```

## 最后说明 ⚠️⚠️⚠️

再次说明，这个操作会使用自定义端口，有端口冲突的风险，还请慎重选择端口，避免冲突。