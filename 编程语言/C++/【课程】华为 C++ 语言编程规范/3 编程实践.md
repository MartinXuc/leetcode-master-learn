[toc]

## 1 函数

### 1.1 输入校验原则

#### 1.1.1 需要校验的边界

- so 或者 dll 之间
- 进程和进程之间
- 应用层进程与操作系统内核
- 可信执行环境内外环境

#### 1.1.2 外部数据的定义

- 文件（包括程序的配置文件）
- 注册表
- 网络
- 环境变量
- 命令行
- 用户输入（包括命令行、界面）
- 用户态数据（对于内核程序）
- 进程间通信（包括管道、消息、共享内存、socket、RPC 等）
- 函数参数（对于 API）

### 1.2 合理选择函数参数与返回类型

#### 1.2.1 函数参数

- 对于输入参数，拷贝代价小的类型传值，拷贝代价大的类型传 `const` 引用
- 对于同时作为输入和输出的参数，传递非 `const` 引用
- 要被移动的参数，应使用右值引用类型，并在函数内使用 `std::move`
- 要被转发的参数使用“转发引用”类型，并在函数内使用 `std:forward`
- 总是要在函数内部产生副本并且移动代价较小的参数，可以按值传递
- 避免定义 C 风格的变参函数
- 尽量避免使用 `void *` 参数
- 不应有未被使用的参数，当由于某种原因需要保留时，应当将参数注释掉

#### 1.2.2 返回类型

- 设计函数时，优先使用返回值而不是输出函数
- 返回多个值时，优先使用返回类型为 `struct` 或 `std::tuple`
- 不要使用 `std::move` 返回函数局部对象

#### 1.2.3 特殊场景

当入参或返回值可能无效时，可以使用 `T*`、`std::optional` 或一个可以代表无效状态的对象

#### 1.2.4 案例

```cpp
void Fun(SomeClass&& x)
{
    Bar(std::move(x));
    ... // x 已经被移走，不能再使用
}
```